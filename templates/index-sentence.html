<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>手書き文章収集</title>
  <style>
    body {
      font-family: sans-serif;
    }
    #canvas {
      border: 1px solid black;
      background: white;
      touch-action: none; /* タッチスクリーンでのスクロール防止 */
    }
    #textInput {
      width: 400px;
      padding: 5px;
      margin-bottom: 10px;
    }
    button {
      padding: 8px 15px;
      margin-top: 5px;
    }
  </style>
</head>
<body>
  <h1>手書き文章収集</h1>

  <label for="textInput">収集する文章: </label><br>
  <input type="text" id="textInput" placeholder="例: 今日は良い天気ですね">
  <br>

  <canvas id="canvas" width="800" height="300"></canvas><br>
  <button id="saveBtn">保存</button>
  <button id="clearBtn">クリア</button>

  <script>
    const textInput = document.getElementById("textInput");
    const canvas = document.getElementById("canvas");
    const ctx = canvas.getContext("2d");
    const saveBtn = document.getElementById("saveBtn");
    const clearBtn = document.getElementById("clearBtn");

    let drawing = false;
    let strokes = [];
    let currentStroke = [];

    // 位置取得
    function getPos(e) {
      const rect = canvas.getBoundingClientRect();
      const clientX = e.clientX || (e.touches && e.touches[0].clientX);
      const clientY = e.clientY || (e.touches && e.touches[0].clientY);
      return { x: clientX - rect.left, y: clientY - rect.top };
    }

    // --- 描画イベントリスナー (変更なし) ---
    // タッチイベント
    canvas.addEventListener("touchstart", (e) => {
      e.preventDefault();
      startDrawing(e);
    }, { passive: false });

    canvas.addEventListener("touchmove", (e) => {
      e.preventDefault();
      draw(e);
    }, { passive: false });

    canvas.addEventListener("touchend", (e) => {
      e.preventDefault();
      endDrawing();
    }, { passive: false });
    
    // マウス・ペンイベント
    canvas.addEventListener("pointerdown", startDrawing);
    canvas.addEventListener("pointermove", draw);
    canvas.addEventListener("pointerup", endDrawing);
    canvas.addEventListener("pointerleave", endDrawing);
    
    // 描画開始
    function startDrawing(e) {
      drawing = true;
      currentStroke = [];
      strokes.push(currentStroke);
      const { x, y } = getPos(e);
      ctx.beginPath();
      ctx.moveTo(x, y);
      currentStroke.push({ x, y });
    }

    // 描画中
    function draw(e) {
      if (!drawing) return;
      const { x, y } = getPos(e);
      ctx.lineTo(x, y);
      ctx.stroke();
      currentStroke.push({ x, y });
    }

    // 描画終了
    function endDrawing() {
      drawing = false;
    }
    
    // --- ボタンの処理 ---

    // クリアボタン
    clearBtn.onclick = () => {
      if (confirm("キャンバスの内容を全て消去しますか？")) {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        strokes = [];
      }
    };

    // 保存ボタン
    saveBtn.onclick = () => {
      const text = textInput.value;

      // 入力チェック
      if (!text.trim()) {
        alert("収集する文章を入力してください。");
        textInput.focus();
        return;
      }
      if (strokes.length === 0 || strokes.every(s => s.length === 0)) {
        alert("キャンバスに何も書かれていません。");
        return;
      }

      // ファイル名を生成
      const now = new Date();
      const timestamp = now.toISOString().replace(/[-:T]/g, "").split(".")[0];
      const filename = `sentence_${timestamp}.json`;

      // JSON作成 (キーを 'char' から 'text' に変更)
      const jsonData = JSON.stringify({
        text: text,
        strokes: strokes,
        filename: filename
      });

      // サーバーへ送信
      fetch("/save", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: jsonData
      }).then(res => {
        if (res.ok) {
          alert(`保存しました: ${filename}`);
          // 保存成功後、キャンバスと入力欄をクリア
          ctx.clearRect(0, 0, canvas.width, canvas.height);
          strokes = [];
          textInput.value = ""; 
        } else {
          alert("保存に失敗しました");
        }
      }).catch(err => {
        console.error("Error:", err);
        alert("サーバーへの送信中にエラーが発生しました。");
      });
    };
  </script>
</body>
</html>