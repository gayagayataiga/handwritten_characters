<!DOCTYPE html>
<html lang="ja">
<head>
	<meta charset="UTF-8">
	<title>手書きひらがな収集</title>
	<style>
		#canvas {
			border: 1px solid black;
			background: white;
		}
	</style>
</head>
<body>
	<h1>手書きひらがな収集</h1>
	<!-- プルダウン -->
	<label for="charSelect">文字を選択:</label>
	<select id="charSelect"></select>
	<canvas id="canvas" width="300" height="300"></canvas><br>
	<button id="saveBtn">保存</button>
	<script>
		// ひらがなセット
		const hiraganaSet = [
			"あ", "い", "う", "え", "お",
			"か", "き", "く", "け", "こ",
			"さ", "し", "す", "せ", "そ",
			"た", "ち", "つ", "て", "と",
			"な", "に", "ぬ", "ね", "の",
			"は", "ひ", "ふ", "へ", "ほ",
			"ま", "み", "む", "め", "も",
			"や", "ゆ", "よ",
			"ら", "り", "る", "れ", "ろ",
			"わ", "を", "ん"
		];
		const select = document.getElementById("charSelect");
		hiraganaSet.forEach(c => {
			const option = document.createElement("option");
			option.value = c;
			option.textContent = c;
			select.appendChild(option);
		});
		const canvas = document.getElementById("canvas");
		const ctx = canvas.getContext("2d");
		let drawing = false;
		let strokes = [];
		let currentStroke = [];
		let currentIndex = 0;

		function getPos(e) {
			const rect = canvas.getBoundingClientRect();
			const clientX = e.clientX || (e.touches && e.touches[0].clientX);
			const clientY = e.clientY || (e.touches && e.touches[0].clientY);
			return { x: clientX - rect.left, y: clientY - rect.top };
		}

		function startDrawing(e) {
			drawing = true;
			currentStroke = [];
			ctx.beginPath();
			const { x, y } = getPos(e);
			ctx.moveTo(x, y);
			currentStroke.push({ x, y });
		}

		function draw(e) {
			if (!drawing) return;
			const { x, y } = getPos(e);
			ctx.lineTo(x, y);
			ctx.stroke();
			currentStroke.push({ x, y });
		}

		function endDrawing() {
			if (drawing) {
				drawing = false;
				strokes.push(currentStroke);
			}
		}

		// イベント設定
		canvas.addEventListener("mousedown", startDrawing);
		canvas.addEventListener("mousemove", draw);
		canvas.addEventListener("mouseup", endDrawing);
		canvas.addEventListener("mouseleave", endDrawing);
		canvas.addEventListener("touchstart", startDrawing);
		canvas.addEventListener("touchmove", draw);
		canvas.addEventListener("touchend", endDrawing);

		// 保存して次へ
		document.getElementById("saveBtn").onclick = () => {
			const char = select.value;
			// JSONに変換
			const jsonData = JSON.stringify({ char: char, strokes: strokes }, null, 2);
			const jsonBlob = new Blob([jsonData], { type: "application/json" });
			const url = URL.createObjectURL(jsonBlob);

			// 現在時刻を取得してファイル名にする
			const now = new Date();
			const timestamp = now.getFullYear().toString()
				+ String(now.getMonth() + 1).padStart(2, '0')
				+ String(now.getDate()).padStart(2, '0')
				+ '_'
				+ String(now.getHours()).padStart(2, '0')
				+ String(now.getMinutes()).padStart(2, '0')
				+ String(now.getSeconds()).padStart(2, '0');

			const filename = `${char}_${timestamp}.json`; // 例: あ_20250919_091530.json

			// ダウンロード
			const a = document.createElement("a");
			a.href = url;
			a.download = filename;
			a.click();

			window.location.reload();

			// 次の文字へ
			currentIndex++;
			if (currentIndex < hiraganaSet.length) {
				document.getElementById("target-char").textContent = hiraganaSet[currentIndex];
				ctx.clearRect(0, 0, canvas.width, canvas.height);
				strokes = [];
			} else {
				alert("全46文字の収集が完了しました！");
			}
		};



	</script>
</body>
</html>